---
title: A copula model for mutlivariate ecological data
author: ''
date: '2020-12-31'
slug: a-copula-model-for-mutlivariate-ecological-data
categories: []
tags:
  - Copula
  - R
bibliography: ref.bib
comments: no
images: ~
---



<pre class="r"><code>#TODO fill good places for copulas </code></pre>
<p>In this blog post I will go though the copula model for ecological data that was proposed by <span class="citation">Anderson et al. (2019)</span>.
I will not go into more details concerning copulas in general so you should have a basic familiarity with the topic. Good places to get acquainted with copulas are:</p>
<div id="prepare-analysis" class="section level1">
<h1>Prepare analysis</h1>
<p>To run this code you will need to install the <em>pacman</em> R package beforehand but this will take care of all the other packages required.</p>
<pre class="r"><code>pacman::p_load(
        corrplot,
        here,
        readxl,
        data.table,
        ecodist,
        dplyr,
        magrittr,
        stringr,
        parallelDist,
        ggplot2,
        usedist,
        vegan,
        rgl
)</code></pre>
<p>you can load the data from here …</p>
<pre class="r"><code>dt_fish &lt;- read_excel(path = &quot;../../../../../Supplementary Informations/Anderson19Copula/ece34948-sup-0001-tables1.xlsx&quot;,
                      skip = 1)</code></pre>
<p>Here I load the function provided in the supplementary materials of Anderson et al. 2019. The original third code file also contains an example use case. I split the file into one containing the functions which we load here and another one which contains the example use case. The delineation is made clear in the RCode3.R file.</p>
<pre class="r"><code>source(&quot;../../../../../Supplementary Informations/Anderson19Copula/RCode1.R&quot;)
source(&quot;../../../../../Supplementary Informations/Anderson19Copula/RCode2.R&quot;)
source(&quot;../../../../../Supplementary Informations/Anderson19Copula/RCode3_functions.R&quot;)</code></pre>
<pre><code>## 
## Attache Paket: &#39;MASS&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     select</code></pre>
<pre><code>## 
## Attache Paket: &#39;extraDistr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:ZIM&#39;:
## 
##     dzinb, dzip, pzinb, pzip, qzinb, qzip, rzinb, rzip</code></pre>
<p>What unique seasons are in the data? The select verb from dplyr is explicitly
loaded from dplyr through the :: sign because the MASS package which will be
loaded inside the chooseDistr() function also contains a select() function
which will mask dplyr’s.</p>
<pre class="r"><code>vec_unique_seasons &lt;-
        dt_fish %&gt;%
        dplyr::select(Time) %&gt;%
        pull() %&gt;%
        unique</code></pre>
<p>Define a function to: 1. Subset data to a certain value of the variable
“Time”, 2. remove the two Variables Sample and Time, and 3. convert the result
to a matrix. The last step is done because the chooseDistr() function requires
a matrix as input. This is done in a function to adhere to the DRY principle:
Don’t repeat yourself. Which mean that in coding you should avoid writing the
same lines of code over and over again to apply them to different objects.
This would make it very cumbersome to fix errors and also to rerun the
analysis.</p>
<pre class="r"><code>tbl_to_mat &lt;- function(sub){
        out &lt;- filter(dt_fish, Time == sub) %&gt;%
                dplyr::select(-c(Sample, Time)) %&gt;%
                as.matrix()
}</code></pre>
<p>The original season names have dots (.) in them. In coding in general you
should avoid dots in the names of objects. In R this is not really a problem
but in other languages they can cause errors, so its a good habit to use
underscores instead.</p>
<pre class="r"><code>for (i in vec_unique_seasons){
        cr_new_i &lt;- i %&gt;%
                str_replace(pattern = &quot;\\.&quot;, replacement = &quot;_&quot;) %&gt;%
                str_to_lower()
        assign(x = paste0(&quot;mt_&quot;,cr_new_i),
               value = tbl_to_mat(sub=i))
        rm(i, cr_new_i)
}</code></pre>
<p>In this loop we first remove species that do not occur in the subsets (i.e.
where the sum of the column is zero). They would cause errors in the
chooseDistr() function. Afterwards we call the function on each matrix.</p>
<pre class="r"><code>for(i in ls()[grepl(pattern=&quot;mt&quot;, x = ls())]){
        mt_loop                         &lt;- get(i)
        rm_id                           &lt;- which(colSums(mt_loop) == 0)
        if (length(rm_id) != 0) mt_loop &lt;- mt_loop[,-rm_id]
        l_cd_out                        &lt;- chooseDistr(Y = mt_loop)
        df_cd_out                       &lt;- l_cd_out$marginals
        cr_save_name_part               &lt;- paste(str_split_fixed(string=i,pattern=&quot;_&quot;,n=3) %&gt;% .[,2:3], collapse = &quot;_&quot;)
        cr_save_name                    &lt;- paste0(&quot;df_&quot;, cr_save_name_part)
        assign(x=i,           value=mt_loop)
        assign(x=cr_save_name,value=df_cd_out)
        rm(i, mt_loop,l_cd_out,df_cd_out,cr_save_name_part,cr_save_name,rm_id);gc()
}</code></pre>
<p>Now we now the optimal marginal distributions for each species and can turn to
the significant pair-wise associations. The function is not well written and
occasionally returns an error. To avoid having to run in manually over and
over again I wrote a while loop.</p>
<pre class="r"><code>pwa_sep_98 = pairWise(
        mt_sep_98,
        nperm = 99999,
        alpha_type = &quot;PCER&quot;,
        graphic = FALSE,
        sig_level = 0.01
)
pwa_sep_99 = pairWise(
        mt_sep_99,
        nperm = 99999,
        alpha_type = &quot;PCER&quot;,
        graphic = FALSE,
        sig_level = 0.01
)
pwa_mar_99 = pairWise(
        mt_mar_99,
        nperm = 99999,
        alpha_type = &quot;PCER&quot;,
        graphic = FALSE,
        sig_level = 0.01
)</code></pre>
<p>We can construct correlation plots just like in the publication. For Index of the observed association (IoA),</p>
<pre class="r"><code>corrplot(pwa_sep_98$IoA.obs, diag = FALSE, type = &quot;lower&quot;, tl.cex = 0.8, tl.srt = 45, tl.col = &quot;black&quot;)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>the shrunken IoA and</p>
<pre class="r"><code>corrplot(pwa_sep_98$IoA.shrunk, diag = FALSE, type = &quot;lower&quot;, tl.cex = 0.8, tl.srt = 45, tl.col = &quot;black&quot;)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>the subset of statistically significant IoAs:</p>
<pre class="r"><code>corrplot(pwa_sep_98$IoA.subset, diag = FALSE, type = &quot;lower&quot;, tl.cex = 0.8, tl.srt = 45, tl.col = &quot;black&quot;)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>add species column. Later functions require this column.</p>
<pre class="r"><code>df_sep_98$Species &lt;- rownames(df_sep_98)
df_mar_99$Species &lt;- rownames(df_mar_99)
df_sep_99$Species &lt;- rownames(df_sep_99)</code></pre>
<p>ids of significant pairwise associated taxa</p>
<pre class="r"><code>s98mt_id &lt;- which(colnames(mt_sep_98) %in%  pwa_sep_98$associated)
s98df_id &lt;- which(rownames(df_sep_98) %in%  pwa_sep_98$associated)
m98mt_id &lt;- which(colnames(mt_mar_99) %in%  pwa_mar_99$associated)
m98df_id &lt;- which(rownames(df_mar_99) %in%  pwa_mar_99$associated)
s99mt_id &lt;- which(colnames(mt_sep_99) %in%  pwa_sep_99$associated)
s99df_id &lt;- which(rownames(df_sep_99) %in%  pwa_sep_99$associated)</code></pre>
<p>new data sets that only hold these subsets</p>
<pre class="r"><code>mt_sep_98_assoc &lt;- mt_sep_98[,s98mt_id]
mt_mar_99_assoc &lt;- mt_mar_99[,s99mt_id]
mt_sep_99_assoc &lt;- mt_sep_99[,s99mt_id]
df_sep_98_assoc &lt;- df_sep_98[s98df_id,]
df_mar_99_assoc &lt;- df_mar_99[s99df_id,]
df_sep_99_assoc &lt;- df_sep_99[s99df_id,]</code></pre>
<pre class="r"><code>li_copula_sep_98 &lt;- estimate_copula(data = mt_sep_98_assoc,marginal_details = df_sep_98_assoc)
li_copula_mar_99 &lt;- estimate_copula(data = mt_mar_99_assoc,marginal_details = df_mar_99_assoc)
li_copula_sep_99 &lt;- estimate_copula(data = mt_sep_99_assoc,marginal_details = df_sep_99_assoc)</code></pre>
<p>Extract the MLE correlation matrix from the mcem_result list.</p>
<pre class="r"><code>corr_mcem_sep_98 &lt;- li_copula_sep_98[[&quot;cov_final&quot;]]
corr_mcem_mar_99 &lt;- li_copula_mar_99[[&quot;cov_final&quot;]]
corr_mcem_sep_99 &lt;- li_copula_sep_99[[&quot;cov_final&quot;]]</code></pre>
<p>We need to add the unassociated species back into the covariance matrix</p>
<pre class="r"><code>add_unass &lt;- function(data, spe_names) {
        new_names &lt;- setdiff(spe_names, row.names(data))
        n_new     &lt;- length(new_names)
        n_old     &lt;- ncol(data)
        mt_add1   &lt;- matrix(0, ncol = ncol(data), nrow = n_new)
        mt_add2   &lt;- matrix(0, ncol = n_new, nrow = nrow(data))
        data &lt;- rbind(data, mt_add1)
        row.names(data)[(n_old+1):(n_old+n_new)] &lt;- new_names
        mt_add2   &lt;- matrix(0, ncol = n_new, nrow = nrow(data))
        data &lt;- cbind(data, mt_add2)
        colnames(data)[(n_old+1):(n_old+n_new)] &lt;- new_names
        diag(data) &lt;- 1
        return(data)
}</code></pre>
<pre class="r"><code>corr_mcem_sep_98_add &lt;- add_unass(data = corr_mcem_sep_98, spe_names = rownames(df_sep_98))
corr_mcem_mar_99_add &lt;- add_unass(data = corr_mcem_mar_99, spe_names = rownames(df_mar_99))
corr_mcem_sep_99_add &lt;- add_unass(data = corr_mcem_sep_99, spe_names = rownames(df_sep_99))</code></pre>
<p>At this stage we can easily simulate new data sets from our copulas.</p>
<pre class="r"><code># How many simulations? 
N = 100
simulated_data_sep_98 =
        generate_copula_data(N, marginal_details = df_sep_98, cov = corr_mcem_sep_98_add)
species_indices &lt;- sample(x = colnames(mt_sep_98), 2)
pch &lt;- c(rep(0, nrow(mt_sep_98)), rep(20, N))
plot(rbind(mt_sep_98[ , species_indices], simulated_data_sep_98[[&quot;observed&quot;]][ , species_indices]), pch = pch, col = c(rep(&quot;red&quot;, nrow(mt_sep_98)), rep(&quot;black&quot;, N)))
legend(x = &quot;topright&quot;, pch = c(0, 20), legend = c(&quot;observed&quot;, &quot;simulated&quot;))</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<pre class="r"><code>n_sim = 100
n_g1 = nrow(mt_sep_98)
n_g2 = nrow(mt_mar_99)
n_g3 = nrow(mt_sep_99)
seas_var = append(rep(vec_unique_seasons[1], n_g1), rep(vec_unique_seasons[2], n_g2))
seas_var = append(seas_var, rep(vec_unique_seasons[3], n_g3))
dt_base = data.table(Sample = 1:56, Time = seas_var)

sim_list = list()
sim_list[[1]] = setDT(dt_fish)
sim_list[[1]][,null_model := FALSE]
for (i in 1:(2*n_sim)){

        ld_s98 &lt;-
                generate_copula_data(n_g1, marginal_details = df_sep_98, cov = corr_mcem_sep_98_add)
        ld_m99 &lt;-
                generate_copula_data(n_g2, marginal_details = df_mar_99, cov = corr_mcem_mar_99_add)
        ld_s99 &lt;-
                generate_copula_data(n_g3, marginal_details = df_sep_99, cov = corr_mcem_sep_99_add)

        mat_new = rbindlist(list(
                as.data.frame(ld_s98[[&quot;observed&quot;]]),
                as.data.frame(ld_m99[[&quot;observed&quot;]]),
                as.data.frame(ld_s99[[&quot;observed&quot;]])
        ), fill = T)

        for (j in seq_len(ncol(mat_new)))
                set(mat_new, which(is.na(mat_new[[j]])), j, 0)

        mat_new = cbind(dt_base, mat_new)
        mat_new[, Time := paste0(Time, &quot;_&quot;, i)]
        mat_new[, null_model := FALSE]
        if (i &lt;= n_sim){
                sim_list[[i+1]] = mat_new
        } else{
                shuffle = sample(1:nrow(mat_new),nrow(mat_new))
                mat_new$Time = mat_new$Time[shuffle]
                mat_new[, null_model := TRUE]
                mat_new[, Time := paste0(Time, &quot;_n&quot;, i-n_sim,&quot;&quot;)]
                sim_list[[i+1]] = mat_new
        }

        rm(mat_new)
}
sim_mat = rbindlist(sim_list, use.names = TRUE)
sim_mat[, Time := factor(Time)]
d_super = parallelDist(x = as.matrix(sim_mat[,-c(1,2)]), method = &quot;bray&quot;, threads = 2)
centroids = betadisper(d_super, sim_mat$Time, type = &quot;centroid&quot;)</code></pre>
<pre class="r"><code>seas_vec = rownames(centroids$centroids)
o_id     = which(!str_detect(seas_vec, &quot;_&quot;))
null_id  = which(str_detect(seas_vec, &quot;n&quot;)) 
seas_vec[null_id] = &quot;null model&quot;

seas_vec %&lt;&gt;% str_remove(&quot;_.*&quot;)
plot_data = data.frame(axis1 = centroids$centroids[,1],
           axis2 = centroids$centroids[,2],
           axis3 = centroids$centroids[,3],
           season = factor(seas_vec), 
           og = FALSE)

plot_data$og[o_id] = TRUE</code></pre>
<pre class="r"><code>p12 = ggplot(data= filter(plot_data, season != &quot;null model&quot;), aes(x = axis1, y = axis2, col = season)) + 
        stat_density_2d(aes(fill = ..level..), geom = &quot;polygon&quot;, alpha = 0.5) +
        geom_point(aes(shape = season)) + 
        geom_point(data = filter(plot_data, og == TRUE), col = &quot;black&quot;, size = 0.5) + 
        theme_classic()
p13 = ggplot(data= filter(plot_data, season != &quot;null model&quot;), aes(x = axis1, y = axis3, col = season)) + 
        stat_density_2d(aes(fill = ..level..), geom = &quot;polygon&quot;, alpha = 0.5) + 
        geom_point(aes(shape = season)) + 
        geom_point(data = filter(plot_data, og == TRUE), col = &quot;black&quot;, size = 0.5) + 
        theme_classic() +
        theme(legend.position = &quot;none&quot;)
p23 = ggplot(data= filter(plot_data, season != &quot;null model&quot;), aes(x = axis2, y = axis3, col = season)) + 
        stat_density_2d(aes(fill = ..level..), geom = &quot;polygon&quot;, alpha = 0.5) + 
        geom_point(aes(shape = season)) + 
        geom_point(data = filter(plot_data, og == TRUE), col = &quot;black&quot;, size = 0.5) + 
        theme_classic()+
        theme(legend.position = &quot;none&quot;)
p12_leg = cowplot::get_legend(p12)
cowplot::plot_grid(p12 + theme(legend.position = &quot;none&quot;),
                   p13,
                   p23,
                   p12_leg)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<pre class="r"><code>p12 = ggplot(data= plot_data, aes(x = axis1, y = axis2, col = season)) + 
        stat_density_2d(aes(fill = ..level..), geom = &quot;polygon&quot;, alpha = 0.5) +
        geom_point(aes(shape = season)) + 
        geom_point(data = filter(plot_data, og == TRUE), col = &quot;black&quot;, size = 0.5) + 
        theme_classic()
p13 = ggplot(data= plot_data, aes(x = axis1, y = axis3, col = season)) + 
        stat_density_2d(aes(fill = ..level..), geom = &quot;polygon&quot;, alpha = 0.5) + 
        geom_point(aes(shape = season)) + 
        geom_point(data = filter(plot_data, og == TRUE), col = &quot;black&quot;, size = 0.5) + 
        theme_classic() +
        theme(legend.position = &quot;none&quot;)
p23 = ggplot(data= plot_data, aes(x = axis2, y = axis3, col = season)) + 
        stat_density_2d(aes(fill = ..level..), geom = &quot;polygon&quot;, alpha = 0.5) + 
        geom_point(aes(shape = season)) + 
        geom_point(data = filter(plot_data, og == TRUE), col = &quot;black&quot;, size = 0.5) + 
        theme_classic()+
        theme(legend.position = &quot;none&quot;)
p12_leg = cowplot::get_legend(p12)
cowplot::plot_grid(p12 + theme(legend.position = &quot;none&quot;),
                   p13,
                   p23,
                   p12_leg)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<pre class="r"><code>colors3d = c(&#39;royalblue1&#39;, &#39;darkcyan&#39;, &#39;oldlace&#39;, &quot;gray&quot;)
plot_data$color &lt;- colors3d[ as.numeric(plot_data$season) ]
plot3d(x = plot_data$axis1, y = plot_data$axis2, z = plot_data$axis3, col = plot_data$color, type = &#39;s&#39;, 
       radius = .005)</code></pre>
</div>
<div id="references" class="section level1 unnumbered">
<h1>References</h1>
<div id="refs" class="references">
<div id="ref-Anderson2019">
<p>Anderson, Marti J., Perry de Valpine, Andrew Punnett, and Arden E. Miller. 2019. “A pathway for multivariate analysis of ecological communities using copulas.” <em>Ecology and Evolution</em> 9 (6): 3276–94. <a href="https://doi.org/10.1002/ece3.4948">https://doi.org/10.1002/ece3.4948</a>.</p>
</div>
</div>
</div>
