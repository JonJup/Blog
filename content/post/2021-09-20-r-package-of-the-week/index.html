---
title: 'R package of the week: corrr'
author: Jonathan Jupke
date: '2021-09-20'
slug: r-package-of-the-week
categories:
  - R package of the week
tags:
  - R package
comments: no
images: ~
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<p>This week we will have a look at the <code>corrr</code> package.
It includes some nice possibilities to visualize correlations between mutliple variables.
I will provide some examples using the varechem data set from the <code>vegan</code> package.</p>
<p>First, load the data and have a look at them.</p>
<pre class="r"><code>data(varechem)
head(varechem) |&gt; knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">N</th>
<th align="right">P</th>
<th align="right">K</th>
<th align="right">Ca</th>
<th align="right">Mg</th>
<th align="right">S</th>
<th align="right">Al</th>
<th align="right">Fe</th>
<th align="right">Mn</th>
<th align="right">Zn</th>
<th align="right">Mo</th>
<th align="right">Baresoil</th>
<th align="right">Humdepth</th>
<th align="right">pH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">18</td>
<td align="right">19.8</td>
<td align="right">42.1</td>
<td align="right">139.9</td>
<td align="right">519.4</td>
<td align="right">90.0</td>
<td align="right">32.3</td>
<td align="right">39.0</td>
<td align="right">40.9</td>
<td align="right">58.1</td>
<td align="right">4.5</td>
<td align="right">0.3</td>
<td align="right">43.9</td>
<td align="right">2.2</td>
<td align="right">2.7</td>
</tr>
<tr class="even">
<td align="left">15</td>
<td align="right">13.4</td>
<td align="right">39.1</td>
<td align="right">167.3</td>
<td align="right">356.7</td>
<td align="right">70.7</td>
<td align="right">35.2</td>
<td align="right">88.1</td>
<td align="right">39.0</td>
<td align="right">52.4</td>
<td align="right">5.4</td>
<td align="right">0.3</td>
<td align="right">23.6</td>
<td align="right">2.2</td>
<td align="right">2.8</td>
</tr>
<tr class="odd">
<td align="left">24</td>
<td align="right">20.2</td>
<td align="right">67.7</td>
<td align="right">207.1</td>
<td align="right">973.3</td>
<td align="right">209.1</td>
<td align="right">58.1</td>
<td align="right">138.0</td>
<td align="right">35.4</td>
<td align="right">32.1</td>
<td align="right">16.8</td>
<td align="right">0.8</td>
<td align="right">21.2</td>
<td align="right">2.0</td>
<td align="right">3.0</td>
</tr>
<tr class="even">
<td align="left">27</td>
<td align="right">20.6</td>
<td align="right">60.8</td>
<td align="right">233.7</td>
<td align="right">834.0</td>
<td align="right">127.2</td>
<td align="right">40.7</td>
<td align="right">15.4</td>
<td align="right">4.4</td>
<td align="right">132.0</td>
<td align="right">10.7</td>
<td align="right">0.2</td>
<td align="right">18.7</td>
<td align="right">2.9</td>
<td align="right">2.8</td>
</tr>
<tr class="odd">
<td align="left">23</td>
<td align="right">23.8</td>
<td align="right">54.5</td>
<td align="right">180.6</td>
<td align="right">777.0</td>
<td align="right">125.8</td>
<td align="right">39.5</td>
<td align="right">24.2</td>
<td align="right">3.0</td>
<td align="right">50.1</td>
<td align="right">6.6</td>
<td align="right">0.3</td>
<td align="right">46.0</td>
<td align="right">3.0</td>
<td align="right">2.7</td>
</tr>
<tr class="even">
<td align="left">19</td>
<td align="right">22.8</td>
<td align="right">40.9</td>
<td align="right">171.4</td>
<td align="right">691.8</td>
<td align="right">151.4</td>
<td align="right">40.8</td>
<td align="right">104.8</td>
<td align="right">17.6</td>
<td align="right">43.6</td>
<td align="right">9.1</td>
<td align="right">0.4</td>
<td align="right">40.5</td>
<td align="right">3.8</td>
<td align="right">2.7</td>
</tr>
</tbody>
</table>
<p>As you can see, the data set contains different soil parameters like Nitrogen, Phosphorus or depth of the humus layer.
The basic function of the <code>corrr</code> package is <code>correlate()</code>, which works similar to base R’s <code>cor()</code>.</p>
<pre class="r"><code>corrr_table &lt;- correlate(varechem, quiet = TRUE)</code></pre>
<p>The main difference between <code>cor()</code> and <code>correlate()</code> is that the latter returns a tibble while the former returns a matrix.
In the call above, I set the <strong>quiet</strong> argument to <code>TRUE</code>.
This prevents the function from returning information on the correlation metric and the method of dealing with missing values.
Both options can be set explicitly with the <strong>method</strong> and <strong>use</strong> arguments.
Here, I used their default values (pearson correlation and only using pairwise complete observations).</p>
<p>The package uses a tibble instead of a matrix so the we can make use of all the tidyverse functions, like
only showing terms with a correlation above 0.7 with zinc …</p>
<pre class="r"><code>corrr_table |&gt; filter(Zn &gt;  0.7) |&gt; pull(term)</code></pre>
<pre><code>## [1] &quot;P&quot;  &quot;Mg&quot; &quot;S&quot;</code></pre>
<p>… or only showing correlations of nirogen and sulphur …</p>
<pre class="r"><code>corrr_table |&gt; select(N, S)</code></pre>
<pre><code>## # A tibble: 14 x 2
##          N       S
##      &lt;dbl&gt;   &lt;dbl&gt;
##  1 NA      -0.262 
##  2 -0.251   0.753 
##  3 -0.147   0.844 
##  4 -0.271   0.540 
##  5 -0.164   0.650 
##  6 -0.262  NA     
##  7 -0.0434  0.360 
##  8  0.165   0.0565
##  9  0.0792  0.275 
## 10 -0.132   0.710 
## 11 -0.0577  0.432 
## 12  0.106   0.0808
## 13  0.0760  0.158 
## 14 -0.0421 -0.187</code></pre>
<p>… or asking what the mean correlation of nitrogen and sulfur to all other variables is.</p>
<pre class="r"><code>corrr_table |&gt; 
  select(N,S) |&gt; 
  map_dbl(~mean(., na.rm = T))</code></pre>
<pre><code>##           N           S 
## -0.07261118  0.33921879</code></pre>
<p>There are also some new data wrangling functions that <code>corrr</code> introduces.
<code>shave()</code> sets the lower or upper triangle to NA.</p>
<pre class="r"><code>shave(corrr_table, upper = TRUE)</code></pre>
<pre><code>## # A tibble: 14 x 15
##    term           N       P       K      Ca      Mg       S      Al     Fe     Mn
##    &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
##  1 N        NA      NA      NA      NA      NA      NA      NA      NA     NA    
##  2 P        -0.251  NA      NA      NA      NA      NA      NA      NA     NA    
##  3 K        -0.147   0.754  NA      NA      NA      NA      NA      NA     NA    
##  4 Ca       -0.271   0.737   0.665  NA      NA      NA      NA      NA     NA    
##  5 Mg       -0.164   0.598   0.628   0.798  NA      NA      NA      NA     NA    
##  6 S        -0.262   0.753   0.844   0.540   0.650  NA      NA      NA     NA    
##  7 Al       -0.0434  0.0453  0.119  -0.206  -0.118   0.360  NA      NA     NA    
##  8 Fe        0.165  -0.128  -0.0941 -0.332  -0.202   0.0565  0.824  NA     NA    
##  9 Mn        0.0792  0.536   0.537   0.443   0.258   0.275  -0.470  -0.436 NA    
## 10 Zn       -0.132   0.702   0.600   0.678   0.708   0.710  -0.0551 -0.312  0.364
## 11 Mo       -0.0577  0.172   0.0682 -0.157   0.0348  0.432   0.510   0.221 -0.205
## 12 Baresoil  0.106   0.0139  0.169   0.178   0.239   0.0808 -0.400  -0.457  0.246
## 13 Humdepth  0.0760  0.152   0.266   0.244   0.371   0.158  -0.494  -0.494  0.510
## 14 pH       -0.0421 -0.0294 -0.233   0.0914 -0.0925 -0.187   0.418   0.440 -0.389
## # ... with 5 more variables: Zn &lt;dbl&gt;, Mo &lt;dbl&gt;, Baresoil &lt;dbl&gt;,
## #   Humdepth &lt;dbl&gt;, pH &lt;dbl&gt;</code></pre>
<p>We can rearrange the columns so that highly correlated columns are next to one another with <code>rearrange()</code>, which I will show below when we come to plots, because this is only relevant for plotting.<br />
The <code>focus()</code> function is very similar to <code>select()</code>. The only difference is that the the <strong>term</strong> column is automatically selected in the <code>focus()</code> functions.</p>
<pre class="r"><code>focus(corrr_table, N) |&gt; 
  head()</code></pre>
<pre><code>## # A tibble: 6 x 2
##   term        N
##   &lt;chr&gt;   &lt;dbl&gt;
## 1 P     -0.251 
## 2 K     -0.147 
## 3 Ca    -0.271 
## 4 Mg    -0.164 
## 5 S     -0.262 
## 6 Al    -0.0434</code></pre>
<p>The last in the bunch is <code>fashion()</code> which can be used to create a nice looking version of the table: no leading zeros, NAs are replace by empty cells</p>
<pre class="r"><code>fashion(corrr_table) |&gt; knitr::kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="left">N</th>
<th align="left">P</th>
<th align="left">K</th>
<th align="left">Ca</th>
<th align="left">Mg</th>
<th align="left">S</th>
<th align="left">Al</th>
<th align="left">Fe</th>
<th align="left">Mn</th>
<th align="left">Zn</th>
<th align="left">Mo</th>
<th align="left">Baresoil</th>
<th align="left">Humdepth</th>
<th align="left">pH</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">N</td>
<td align="left"></td>
<td align="left">-.25</td>
<td align="left">-.15</td>
<td align="left">-.27</td>
<td align="left">-.16</td>
<td align="left">-.26</td>
<td align="left">-.04</td>
<td align="left">.17</td>
<td align="left">.08</td>
<td align="left">-.13</td>
<td align="left">-.06</td>
<td align="left">.11</td>
<td align="left">.08</td>
<td align="left">-.04</td>
</tr>
<tr class="even">
<td align="left">P</td>
<td align="left">-.25</td>
<td align="left"></td>
<td align="left">.75</td>
<td align="left">.74</td>
<td align="left">.60</td>
<td align="left">.75</td>
<td align="left">.05</td>
<td align="left">-.13</td>
<td align="left">.54</td>
<td align="left">.70</td>
<td align="left">.17</td>
<td align="left">.01</td>
<td align="left">.15</td>
<td align="left">-.03</td>
</tr>
<tr class="odd">
<td align="left">K</td>
<td align="left">-.15</td>
<td align="left">.75</td>
<td align="left"></td>
<td align="left">.66</td>
<td align="left">.63</td>
<td align="left">.84</td>
<td align="left">.12</td>
<td align="left">-.09</td>
<td align="left">.54</td>
<td align="left">.60</td>
<td align="left">.07</td>
<td align="left">.17</td>
<td align="left">.27</td>
<td align="left">-.23</td>
</tr>
<tr class="even">
<td align="left">Ca</td>
<td align="left">-.27</td>
<td align="left">.74</td>
<td align="left">.66</td>
<td align="left"></td>
<td align="left">.80</td>
<td align="left">.54</td>
<td align="left">-.21</td>
<td align="left">-.33</td>
<td align="left">.44</td>
<td align="left">.68</td>
<td align="left">-.16</td>
<td align="left">.18</td>
<td align="left">.24</td>
<td align="left">.09</td>
</tr>
<tr class="odd">
<td align="left">Mg</td>
<td align="left">-.16</td>
<td align="left">.60</td>
<td align="left">.63</td>
<td align="left">.80</td>
<td align="left"></td>
<td align="left">.65</td>
<td align="left">-.12</td>
<td align="left">-.20</td>
<td align="left">.26</td>
<td align="left">.71</td>
<td align="left">.03</td>
<td align="left">.24</td>
<td align="left">.37</td>
<td align="left">-.09</td>
</tr>
<tr class="even">
<td align="left">S</td>
<td align="left">-.26</td>
<td align="left">.75</td>
<td align="left">.84</td>
<td align="left">.54</td>
<td align="left">.65</td>
<td align="left"></td>
<td align="left">.36</td>
<td align="left">.06</td>
<td align="left">.27</td>
<td align="left">.71</td>
<td align="left">.43</td>
<td align="left">.08</td>
<td align="left">.16</td>
<td align="left">-.19</td>
</tr>
<tr class="odd">
<td align="left">Al</td>
<td align="left">-.04</td>
<td align="left">.05</td>
<td align="left">.12</td>
<td align="left">-.21</td>
<td align="left">-.12</td>
<td align="left">.36</td>
<td align="left"></td>
<td align="left">.82</td>
<td align="left">-.47</td>
<td align="left">-.06</td>
<td align="left">.51</td>
<td align="left">-.40</td>
<td align="left">-.49</td>
<td align="left">.42</td>
</tr>
<tr class="even">
<td align="left">Fe</td>
<td align="left">.17</td>
<td align="left">-.13</td>
<td align="left">-.09</td>
<td align="left">-.33</td>
<td align="left">-.20</td>
<td align="left">.06</td>
<td align="left">.82</td>
<td align="left"></td>
<td align="left">-.44</td>
<td align="left">-.31</td>
<td align="left">.22</td>
<td align="left">-.46</td>
<td align="left">-.49</td>
<td align="left">.44</td>
</tr>
<tr class="odd">
<td align="left">Mn</td>
<td align="left">.08</td>
<td align="left">.54</td>
<td align="left">.54</td>
<td align="left">.44</td>
<td align="left">.26</td>
<td align="left">.27</td>
<td align="left">-.47</td>
<td align="left">-.44</td>
<td align="left"></td>
<td align="left">.36</td>
<td align="left">-.20</td>
<td align="left">.25</td>
<td align="left">.51</td>
<td align="left">-.39</td>
</tr>
<tr class="even">
<td align="left">Zn</td>
<td align="left">-.13</td>
<td align="left">.70</td>
<td align="left">.60</td>
<td align="left">.68</td>
<td align="left">.71</td>
<td align="left">.71</td>
<td align="left">-.06</td>
<td align="left">-.31</td>
<td align="left">.36</td>
<td align="left"></td>
<td align="left">.28</td>
<td align="left">.04</td>
<td align="left">.14</td>
<td align="left">-.09</td>
</tr>
<tr class="odd">
<td align="left">Mo</td>
<td align="left">-.06</td>
<td align="left">.17</td>
<td align="left">.07</td>
<td align="left">-.16</td>
<td align="left">.03</td>
<td align="left">.43</td>
<td align="left">.51</td>
<td align="left">.22</td>
<td align="left">-.20</td>
<td align="left">.28</td>
<td align="left"></td>
<td align="left">.03</td>
<td align="left">.06</td>
<td align="left">-.17</td>
</tr>
<tr class="even">
<td align="left">Baresoil</td>
<td align="left">.11</td>
<td align="left">.01</td>
<td align="left">.17</td>
<td align="left">.18</td>
<td align="left">.24</td>
<td align="left">.08</td>
<td align="left">-.40</td>
<td align="left">-.46</td>
<td align="left">.25</td>
<td align="left">.04</td>
<td align="left">.03</td>
<td align="left"></td>
<td align="left">.59</td>
<td align="left">-.53</td>
</tr>
<tr class="odd">
<td align="left">Humdepth</td>
<td align="left">.08</td>
<td align="left">.15</td>
<td align="left">.27</td>
<td align="left">.24</td>
<td align="left">.37</td>
<td align="left">.16</td>
<td align="left">-.49</td>
<td align="left">-.49</td>
<td align="left">.51</td>
<td align="left">.14</td>
<td align="left">.06</td>
<td align="left">.59</td>
<td align="left"></td>
<td align="left">-.72</td>
</tr>
<tr class="even">
<td align="left">pH</td>
<td align="left">-.04</td>
<td align="left">-.03</td>
<td align="left">-.23</td>
<td align="left">.09</td>
<td align="left">-.09</td>
<td align="left">-.19</td>
<td align="left">.42</td>
<td align="left">.44</td>
<td align="left">-.39</td>
<td align="left">-.09</td>
<td align="left">-.17</td>
<td align="left">-.53</td>
<td align="left">-.72</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<p>While all these things are nice the really cool thing about <code>corrr</code> is the plots:</p>
<pre class="r"><code>corrr_table |&gt; 
  rearrange() |&gt; 
  rplot()</code></pre>
<pre><code>## Registered S3 method overwritten by &#39;seriation&#39;:
##   method         from 
##   reorder.hclust vegan</code></pre>
<pre><code>## Don&#39;t know how to automatically pick scale for object of type noquote. Defaulting to continuous.</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>and</p>
<pre class="r"><code>corrr_table |&gt; 
  network_plot()</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>In the network plot highly correlated variables appear closer together and are joined by stronger (darker) paths.
The function includes an argument to exclude correlations below some threshold (<code>min_cor</code>), to change the color scale (<code>colours</code>), and lastly and a argument for whether arrows should be straight or curved (<code>curved</code>).
So we could modify the above plot to this:</p>
<pre class="r"><code>corrr_table |&gt; 
  network_plot(
          min_cor = 0.5,
          colours = c(&quot;green&quot;, &quot;black&quot;, &quot;blue&quot;),
          curved = FALSE
  )</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>Yes, the first one was prettier but now you know what you can do with this.</p>
