---
title: 'Species Distribution Modeling with HMSC '
author: 'Jonathan Jupke '
date: '2020-10-26'
slug: species-distribution-modeling-with-hmsc
categories: []
tags:
  - R
  - HMSC
  - MOD3
comments: no
images: ~
---

```{r}
#TODO where did I get the Data from? 
#TODO add link to multispecies example
```


Intro text 

To run this code you will need to install the pacman R package beforehand but this will take care of all the other packages required. 

```{r setup, echo=TRUE}
pacman::p_load(abind, data.table, ggplot2, here, Hmsc, magrittr)
```

```{r load data, echo=FALSE}
data.directory="~/01_Uni/01_Lehre/05_MOD3-Lecture/001_raw_data/hmsc_birds/data"
model.path="~/01_Uni/01_Lehre/05_MOD3-Lecture/003_processed_data/hmsc_mcmc/corvusmonedula/"
```

We use the Finnish bird data that are also often used by the creators of HMSC to demonstrate the package (e.g. here and here). In this example we will focus on a single species, the Western Jackdaw (*Corvus monedula*). You can find an example with a joint species distribution model, that makes use of all features of HMSC, here. 
We also look at just one year (2014) while the data set contains the year 2006 to 2014. 

```{r carpet data, echo=T}
data = fread(file.path(data.directory, "data.csv"))
data = data[Year == 2014]
data %<>% droplevels()

XData = as.data.frame(data[, c("Habitat", "AprMay")])
names(XData) = c("hab", "clim")

Y = as.matrix(data$Corvus_monedula)
colnames(Y) = "Corvus monedula"

xy = as.matrix(data[, c("x", "y")])
studyDesign = data.frame(route = factor(data$Route))
rownames(xy) = studyDesign[, 1]
rL = HmscRandomLevel(sData = xy)

XFormula =  ~ hab + poly(clim, degree = 2, raw = TRUE)
```
Fit the model 
```{r}
m_full = Hmsc(Y=Y,
              XData=XData,
              XFormula=XFormula,
              distr = "lognormal poisson",
              studyDesign = studyDesign,
              ranLevels=list(route=rL))
```
Run MCMC 
```{r run MCMC, eval = FALSE}
nChains = 2
thin = c(5, 10, 100)
nParallel = max(round(parallel::detectCores() / 2), nChains)
samples = 1000
transient = 500 * thin
verbose = 500 * thin

for (i in seq_along(thin)) {
        model[[i]] = sampleMcmc(
                m_full,
                thin = thin[i],
                samples = samples,
                transient = transient,
                nChains = nChains,
                verbose = verbose,
                initPar = "fixed effects"

        )
}

```
```{r load mcmc result, echo=F}
model=list()
model[[1]]=readRDS(file.path(model.path, "hmsc_cm_models5.RDS"))
model[[2]]=readRDS(file.path(model.path, "hmsc_cm_models10.RDS"))
model[[3]]=readRDS(file.path(model.path, "hmsc_cm_models100.RDS"))
```

```{r mcmc-plots1, fig.align="center"}
for (i in seq_along(model)) {
        mpost[[i]] = convertToCodaObject(model[[i]],
                                         spNamesNumbers = c(T, F),
                                         covNamesNumbers = c(T, F))
}
plot(mpost[[1]]$Beta)
```
```{r mcmc-plots2}
plot(mpost[[2]]$Beta)
```
```{r mcmc-plots3}
plot(mpost[[3]]$Beta)
```
